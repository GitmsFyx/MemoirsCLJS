---
categories: Asp.net
---

# Serilog

第三方框架,原ASP框架Log无法持久化

ASP项目安装一下两个包

`Serilog`

`Serilog.AspNetCore`

## 使用

```C#
//Program.cs
//这个方法会自动添加依赖注入
builder.Host.UseSerilog((HostBuilderContext context, IServiceProvider services,
    LoggerConfiguration loggerConfiguration) =>
{
    loggerConfiguration
        .ReadFrom.Configuration(context.Configuration)
        .ReadFrom.Services(services);
});
```
appsetting
```JSon
 "Serilog": {
    "MinimumLevel": "Information",
    "Using": ["Serilog.Sinks.Console","Serilog.Sinks.File"],
    "WriteTo": [{
      "Name": "Console"
    },{
      "Name": "File",
      "Args": {
        "path": "logs/log.txt",
        "rollingInterval":"Hour",
        "fileSizeLimitBytes": 1048576,
        "rollOnFileSizeLimit": true
      }
    }
    ]
  }
```
rollOnFileSizeLimit推荐为true,默认为false,如果为false,达到文件大小上限后将不记录，也就是丢失日志.

## 数据库
`Serilog.Sinks.MSSqlServer` 需要装包

Serilog不能自动创建数据库，这不安全. 需要手动自己创建.

```Json
  "Serilog": {
    "MinimumLevel": "Information",
    "Using": ["Serilog.Sinks.MSSqlServer"],
    "WriteTo": [
      {
        "Name": "MSSqlServer",
        "Args": {
          "connectionString": "Data Source=DESKTOP-BM8RVC7\\SQLEXPRESS;Initial Catalog=CRUDLogs;Integrated Security=True;Persist Security Info=False;Pooling=False;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=True;Application Name=\"SQL Server Management Studio\";Command Timeout=0",
          "tableName": "logs",
          "autoCreateSqlTable": true

        }
      }
    ]
  }

}

```

## Seq

结构化日志，易于搜索

`seq datalust` 浏览器下载该软件

`Serilog.Sinks.Seq` nuget包

```C#
"Serilog": {
    "MinimumLevel": "Information",
    "Using": ["Serilog.Sinks.Seq"],
    "WriteTo": [{
        "Name": "Seq",
        "Args": {
          "serverUrl": "http://localhost:5341"
        }
      }
    ]
  }
  
```

## Serilog 增强 ,添加自定义信息

RequestId:重要信息，由ASP.net生成.

appsetting,在同一个ASP程序中添加ApplicationName属性.
```Json
 "Serilog": {
    "Enrich": ["FromLogContext"],
    "Properties": {
      "ApplicationName": "CRUD Demo App"
    }
  }
```

## 诊断上下文

IDiagnosticContext

`Serilog.Extensions.Hosting`

```C#
//注入
public PersonsesService(IDiagnosticContext diagnosticContext)
{
    _diagnosticContext = diagnosticContext;
}

SomeMethod()
{
  _diagnosticContext.Set("Person", person);
}



```

```C#
//Program.cs

//当端点连接时候自动记录
app.UseSerilogRequestLogging();
```

## Timing

用来记录某些方法执行的时间的日志.

`SerilogTimings` Nuget包

```C#
using (Operation.Time("Time for Filtered Persons from Database")) 
{
    //Method();
}
```
会自动发送日志，并且记录运行时间