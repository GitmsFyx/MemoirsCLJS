---
categories: ASP.net
---

# Service

服务层,创建一个新类库项目,方便复用,测试,架构清晰.

>[!TIP]
>建议写在一个新项目里面,可以让多个项目引用.

## DI 依赖注入

可以松耦合,也方便协同开发.依赖抽象接口.

这样只需定义一个接口就可以同时开发  
Controller -> interface <- Service

```C#
//Program.cs

//注册服务
builder.Services.Add(new ServiceDescriptor(typeof(ICitiesService), typeof(CitiesService),ServiceLifetime.Transient));

//更方便的方法,推荐
builder.Service.AddTransient<>();
```

```C#
public class HomeController : Controller
{
    private readonly ICitiesService _citiesService;
    
    //会自动在构造函数中注入
    public HomeController(ICitiesService citiesService)
    {
        _citiesService = citiesService; //new CitiesService();
    }
    
}
```

[FromServices] 某个方法的参数由依赖注入而来. *实际使用很少*
```C#
[Route("/")]
//特指这个参数由依赖注入服务得来
public ActionResult Index([FromServices]ICitiesService _citiesService)
{
    var cities = _citiesService.GetCities();
    return View(cities);
}
```

### 依赖注入周期

单例

作用域

瞬态

### 作用域

*   ASP启动的时候会创建一个`Root Scope` 根作用域
*   每个请求会创建一个`Request Scope` 请求作用域
*   子作用域(IServiceScopeFactory serviceScopeFactory,内置的,不需要注册)
        
        //创建一个子作用域,它会自动调用里面作用域的Dispose()
        using (IServiceScope scope = _serviceScopeFactory.CreateScope())
        {
            //由这个作用域依赖注入一个实例
            //ICitiesService必须被注册为Scope
            var citiesService = scope.ServiceProvider.GetService<ICitiesService>();
        }


### 视图注入

`@inject` 如果是Scope 那么会得到同一个服务,因为在同一个请求下

### 注意事项

*   只在子作用域里面使用GetService，其他时候使用构造器注入,因为这样方便查看依赖 
*   尽量不要手动调用`Dispose()` ,这是IOC容器的职责
*   不要将瞬态服务（或作用域服务）注入单例服务,要不然瞬态服务会跟随单例服务的生命周期
*   不要将依赖注入的服务设置为`public`并共享给其他类使用,因为其他类使用的时候该服务可能已经释放了(这也不符合依赖注入模式),都应通过自身构造器函数注入服务.


### Autofac

第三方IOC容器,比内置稍微强一点,多了两个周期.**了解即可**

需要
`Autofac` 和
`Autofac.Extensions.DependencyInjection` 两个包


```C#
var builder = WebApplication.CreateBuilder(args);
//在CreateBuilder后一行加入以下代码
//UseServiceProviderFactory使用第三方服务提供工厂,传入Autofac的工厂
builder.Host.UseServiceProviderFactory(new AutofacServiceProviderFactory());

//服务注册,感觉这API很不直观
builder.Host.ConfigureContainer<ContainerBuilder>(containerBuilder =>
{
    containerBuilder.RegisterType<CitiesService>().As<ICitiesService>().InstancePerDependency();// AddTransient
    
    containerBuilder.RegisterType<CitiesService>().As<ICitiesService>().InstancePerLifetimeScope();// AddScoped

});
```

```C#
public class HomeController : Controller
{
    private readonly ICitiesService _citiesService;
    //改成ILifetimeScope
    private readonly ILifetimeScope _lifetimeScope;
    
    //改成ILifetimeScope
    public HomeController(ICitiesService citiesService,ILifetimeScope lifetimeScope)
    {
        _citiesService = citiesService; //new CitiesService();
        _lifetimeScope= lifetimeScope;
    }
    
    [Route("/")]
    public ActionResult Index([FromServices]ICitiesService _citiesService)
    {
        var cities = _citiesService.GetCities();

        //改成ILifetimeScope
        using (ILifetimeScope scope = _lifetimeScope.BeginLifetimeScope())
        {
            //改成Autofac的写法
            var citiesService = scope.Resolve<ICitiesService>();
        }
        
        return View(cities);
    }

}
```