---
categories : ASP.net
---

# CSV

生成CSV

`CsvHelper`安装包

```C#
//Service.cs
public async Task<MemoryStream> GetPersonsCSV()
{
    //内存流,因为没有源文件
    MemoryStream memoryStream = new MemoryStream();
    //用来写文件的
    StreamWriter streamWriter = new StreamWriter(memoryStream);

    //CultureInfo.InvariantCulture 文化信息,也就是偏好,InvariantCulture为默认.
    //leaveOpen:true关键参数 表示不要关闭底层的MemoryStream和StreamWriter
    CsvWriter csvWriter = new CsvWriter(streamWriter, CultureInfo.InvariantCulture,leaveOpen:true);
  
    var persons = _personsDbContext.Persons.Include(p=>p.Country).Select(p=>p.ToPersonResponse()).ToList();

    //写入表头
    csvWriter.WriteHeader<PersonResponse>();

    //换行,相当于\n
    await csvWriter.NextRecordAsync();

    //写入列表数据
    await csvWriter.WriteRecordsAsync(persons);

    //将流的光标指向第一个，因为在控制器中,还要再次操作这个流
    memoryStream.Position = 0;

    return memoryStream;

}
```

```C#
//Controller.cs
[Route("[action]")]
public async Task<IActionResult> PersonsCSV()
{
    //得到流
    var memoryStream = await _personsService.GetPersonsCSV();

    //返回文件类型的
    return File(memoryStream,"application/csv","persons.csv");
}
```

## 自定义,可以控制写什么

将方法改变一下
```C#
public async Task<MemoryStream> GetPersonsCSV()
{
    MemoryStream memoryStream = new MemoryStream();
    StreamWriter streamWriter = new StreamWriter(memoryStream);

    //自己创建csvConfiguration,自带LeaveOpen:true
    CsvConfiguration csvConfiguration = new CsvConfiguration(CultureInfo.InvariantCulture);

    CsvWriter csvWriter = new CsvWriter(streamWriter, csvConfiguration);
    
    var persons = _personsDbContext.Persons.Include(p=>p.Country).Select(p=>p.ToPersonResponse()).ToList();

    //自己写表头
    csvWriter.WriteField(nameof(PersonResponse.PersonName));
    csvWriter.WriteField(nameof(PersonResponse.Email));
    csvWriter.WriteField(nameof(PersonResponse.DateOfBirth));
    csvWriter.WriteField(nameof(PersonResponse.Age));
    csvWriter.WriteField(nameof(PersonResponse.Gender));
    csvWriter.WriteField(nameof(PersonResponse.Country));
    //比如这里就可以不写Address
    //csvWriter.WriteField(nameof(PersonResponse.Address));
    csvWriter.WriteField(nameof(PersonResponse.ReceiveNewsLetters));
    await csvWriter.NextRecordAsync();

    foreach (var personResponse in persons)
    {
        csvWriter.WriteField(personResponse.PersonName);
        csvWriter.WriteField(personResponse.Email);
        csvWriter.WriteField(personResponse.DateOfBirth?.ToString());
        csvWriter.WriteField(personResponse.Age);
        csvWriter.WriteField(personResponse.Gender);
        csvWriter.WriteField(personResponse.Country);
        //隐藏Address
        //csvWriter.WriteField(personResponse.Address);
        csvWriter.WriteField(personResponse.ReceiveNewsLetters);
        //换行
        await csvWriter.NextRecordAsync();
        //使用flush,将缓冲区写入,
        //好处是可以一点一点写,也可以实现实时写入,如果不写,那么将没有数据.
        await csvWriter.FlushAsync();
    }
    
    memoryStream.Position = 0;

    return memoryStream;

}
```