---
categories : ASP.net
---

# Excel

~~`EPPlus` NuGet包~~ 非商用

`ClosedXML` NuGet包 ,只能操作新版`.xlsx`,老板`.xls`不支持

```C#
//Service.cs
public async Task<MemoryStream> GetPersonsExcel()
{
    var persons = await _personsDbContext.Persons.Select(p=>p.ToPersonResponse()).ToListAsync();
    var memoryStream = new MemoryStream();

    //创建EXCEL BOOK
    using (var wb = new XLWorkbook())
    {   
        //添加表
        var ws = wb.AddWorksheet();
        //从A1位置插入表头和数据,InsertData只插入数据
        ws.Cell("A1").InsertTable(persons);
        //保存到流
        wb.SaveAs(memoryStream);
    }

    //将流光标设置到开头,否则返回的时候光标在最后,controller读入为空
    memoryStream.Position = 0;
    return memoryStream;

}
```

```C#
//Controller.cs
[Route("[action]")]
public async Task<IActionResult> PersonsExcel()
{
    var memoryStream = await _personsService.GetPersonsExcel();
    
    return File(memoryStream, "application/vnd.ms-excel", "persons.xlsx");
}
```

如果要自定义可以用 `ws.Cell("A1").InsertData(data)`,可以`foreach`一行一行写入,也可以按照文档的硬写方式.

## 从Excel上传到数据库

`Microsoft.AspNetCore.Http` 安装NuGet包,里面有IFromFile

定义接口
```C#
//IService.cs

Task<int> UploadCountriesFromExcelFile(IFormFile formFile);
```
实现接口方法
```C#
///
public async Task<int> UploadCountriesFromExcelFile(IFormFile formFile)
    {
        //创建一个空内存流
        var memoryStream = new MemoryStream();

        //将传入的IFormFile复制到该内存流
        await formFile.CopyToAsync(memoryStream);

        //返回插入的数据数量
        int countriesInserted = 0;

        //使用流创建Excel Book,
        using (var xlWorkbook = new XLWorkbook(memoryStream))
        {   
            //获得Countries表,注意是表名,不是文件名
            IXLWorksheet xlWorksheet = xlWorkbook.Worksheet("Countries");
            
            //得到表的有效行高
            var rowCount = xlWorksheet.RowHeight;

            //第一行是表头,数据从第二行开始
            for (int row = 2; row <= rowCount; row++)
            {
                //将行数据转化为字符串
                string? cellValue = xlWorksheet.Cell(row,1).Value.ToString();
                
                //为空跳过
                if (string.IsNullOrEmpty(cellValue)) continue;
                
                
                string? countryName = cellValue;

                //检查数据库是否已经该数据
                if (_personsDbContext.Countries.Any(c => c.CountryName == countryName)) continue;
                
                //添加数据
                await _personsDbContext.Countries.AddAsync(new Country { CountryName = countryName });
                await _personsDbContext.SaveChangesAsync();
                countriesInserted++;
                
            }
            return countriesInserted;
        }
    }
```
创建视图
```html
@{
    ViewBag.Title="Upload Countries From Excel";
}

<h1>Upload Countries From Excel</h1>
<div class="w-50">
    <!--enctype:application/x-www-form-urlencoded不能接受文件,所以只能multipart/form-data-->
    <form asp-controller="Countries" asp-action="UploadFromExcel" method="post" enctype="multipart/form-data">
        <div class="flex">
            <div class="w-25">
                <label class="form-label pt">Choose a xlsx file</label>
            </div>
            
            <div class="flex-1">
                <!--只有有name的才会提交,excelFile注意这个名字必须和action接受参数一致-->
                <input type="file" name="excelFile" class="form-input"/>
                <div class="text-red">@ViewBag.ErrorMessage</div>
                <div class="text-green">@ViewBag.Message</div>
            </div>
        </div>
        
        <div class="form-input flex">
            <div class="w-25"></div>
            <div class="flex-1">
                <!--submit是提交按钮,button是不提交的本地按钮-->
                <button type="submit" class="button button-green-back">Upload</button>
            </div>
        </div>
    </form>

</div>
```
实现控制器
```C#
[Route("[controller]")]
public class CountriesController : Controller
{
    private readonly ICountriesService _countriesService;

    public CountriesController(ICountriesService countriesService)
    {
        _countriesService = countriesService;
    }
    
    //默认为GET
    [Route("[action]")]
    public ActionResult UploadFromExcel()
    {
        return View();
    }
    
    [HttpPost]
    [Route("[action]")]
    public async Task<IActionResult> UploadFromExcel(IFormFile excelFile)
    {   
        //不为空
        if (excelFile==null|| excelFile.Length==0)
        {
            ViewBag.ErrorMessage = "Please select excel file";
            return View();
        }

        //文件必须为 .xlsx
        if (Path.GetExtension(excelFile.FileName)!=".xlsx")
        {
            ViewBag.ErrorMessage = "Please select .xlsx file";
            return View();
        }
        
        //插入
        var uploadCountriesNumber = await _countriesService.UploadCountriesFromExcelFile(excelFile);

        ViewBag.Message = $"{uploadCountriesNumber} Countries Uploaded";
        return View();
    }
}

