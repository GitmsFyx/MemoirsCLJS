---
categories : ASP.net
---

# Excel

~~`EPPlus` NuGet包~~ 非商用

`ClosedXML` NuGet包 ,只能操作新版`.xlsx`,老板`.xls`不支持

```C#
//Service.cs
public async Task<MemoryStream> GetPersonsExcel()
{
    var persons = await _personsDbContext.Persons.Select(p=>p.ToPersonResponse()).ToListAsync();
    var memoryStream = new MemoryStream();

    //创建EXCEL BOOK
    using (var wb = new XLWorkbook())
    {   
        //添加表
        var ws = wb.AddWorksheet();
        //从A1位置插入表头和数据,InsertData只插入数据
        ws.Cell("A1").InsertTable(persons);
        //保存到流
        wb.SaveAs(memoryStream);
    }

    //将流光标设置到开头,否则返回的时候光标在最后,controller读入为空
    memoryStream.Position = 0;
    return memoryStream;

}
```

```C#
//Controller.cs
[Route("[action]")]
public async Task<IActionResult> PersonsExcel()
{
    var memoryStream = await _personsService.GetPersonsExcel();
    
    return File(memoryStream, "application/vnd.ms-excel", "persons.xlsx");
}
```

如果要自定义可以用 `ws.Cell("A1").InsertData(data)`,可以`foreach`一行一行写入,也可以按照文档的硬写方式.