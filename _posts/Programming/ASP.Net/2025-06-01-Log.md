---
categories: ASP.net
---

# 日志

默认最低级别为`Information`.

appsettings.json
```C#
//默认显示的为Information及以上的日志
//Microsoft.AspNetCore是框架默认会提供的日志，我们只要Warning及以上的.
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
```

## 默认查看

控制台

Debug调试器(VS)

Event Viewer ,Windows系统自带程序,捕捉不同原因不同程序的事件,默认为Information.可以在appsetting中修改.

```C#
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    },
    "EventLog": {
      "LogLevel": {
        "Default": "Debug"
      }
    }
  }
}
```

## 启动日志

`builder.Logging.ClearProviders();`
清除所有日志提供者(框架默认会提供3种)

`builder.Logging.AddConsole();` 添加控制台日志

`builder.Logging.AddDebug();` 添加Debug调试器

`builder.Logging.AddEventLog();` 添加EventLog

`builder.Logging.AddSimpleConsole(i=>i.ColorBehavior=LoggerColorBehavior.Disabled);`
添加简易控制台日志，并且设置没有颜色

`app.Logger.LogInformation("Adding Routes");`

## 创建ILogger

传入泛型，将日志以该实例分类 
```C#
public class PrivacyModel : PageModel
{
    private readonly ILogger<PrivacyModel> _logger;

    public PrivacyModel(ILogger<PrivacyModel> logger)
    {
        _logger = logger;
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.PrivacyModel called.");
    }
}
```
用名称分类 
```C#
public class ContactModel : PageModel
{
    private readonly ILogger _logger;

    public ContactModel(ILoggerFactory logger)
    {
        _logger = logger.CreateLogger("TodoApi.Pages.ContactModel.MyCategory");
    }

    public void OnGet()
    {
        _logger.LogInformation("GET Pages.ContactModel called.");
    }
}
```

## 日志级别


    //以下事件ID是自定义类
    public class MyLogEvents
    {
        public const int GenerateItems = 1000;
        public const int ListItems     = 1001;
        public const int GetItem       = 1002;
        public const int InsertItem    = 1003;
        public const int UpdateItem    = 1004;
        public const int DeleteItem    = 1005;

        public const int TestItem      = 3000;

        public const int GetItemNotFound    = 4000;
        public const int UpdateItemNotFound = 4001;
    }


    [HttpGet]
    public IActionResult Test1(int id)
    {
        //routeInfo会显示Controller和razorPage路线信息
        var routeInfo = ControllerContext.ToCtxString(id);

        //这两种写法作用相同,MyLogEvents.TestItem是事件ID,
        _logger.Log(LogLevel.Information, MyLogEvents.TestItem, routeInfo);
        _logger.LogInformation(MyLogEvents.TestItem, routeInfo);

        return ControllerContext.MyDisplayRouteInfo();
    }

    //创建不同级别的日志
    [HttpGet("{id}")]
    public async Task<ActionResult<TodoItemDTO>> GetTodoItem(long id)
    {
        //MyLogEvents.GetItem是事件ID,第二个参数是消息模板.
        _logger.LogInformation(MyLogEvents.GetItem, "Getting item {Id}", id);

        var todoItem = await _context.TodoItems.FindAsync(id);

        if (todoItem == null)
        {
            //
            _logger.LogWarning(MyLogEvents.GetItemNotFound, "Get({Id}) NOT FOUND", id);
            return NotFound();
        }

        return ItemToDTO(todoItem);
    }

    info: TodoApi.Controllers.TodoItemsController[1002]
        Getting item 1
    warn: TodoApi.Controllers.TodoItemsController[4000]
        Get(1) NOT FOUND

## 筛选

    var builder = WebApplication.CreateBuilder();
    builder.Logging.AddFilter((provider, category, logLevel) =>
    {
        if (provider.Contains("ConsoleLoggerProvider")
            && category.Contains("Controller")
            && logLevel >= LogLevel.Information)
        {
            return true;
        }
        else if (provider.Contains("ConsoleLoggerProvider")
            && category.Contains("Microsoft")
            && logLevel >= LogLevel.Information)
        {
            return true;
        }
        else
        {
            return false;
        }
    });

## HTTP 记录

```C#
//添加默认配置，默认除了请求体和响应体都有，因为它们有性能缺陷
builder.Services.AddHttpLogging(o => { }); 

//自定义
builder.Services.AddHttpLogging(logging =>
{
    //logging.LoggingFields = HttpLoggingFields.RequestProperties|HttpLoggingFields.ResponsePropertiesAndHeaders
    logging.LoggingFields = HttpLoggingFields.All;
    //记录sec-ch-ua请求头的值
    logging.RequestHeaders.Add("sec-ch-ua");
    //记录MyResponseHeader响应头的值      
    logging.ResponseHeaders.Add("MyResponseHeader");

    logging.MediaTypeOptions.AddText("application/javascript");
    logging.RequestBodyLogLimit = 4096;
    logging.ResponseBodyLogLimit = 4096;
    logging.CombineLogs = true;
});

//使用 如果要为静态文件启用日志，那么要在UseStaticFiles前使用
//只是启用，会在任何一个记录Log的地方看到
app.UseHttpLogging(); 
```

`"Microsoft.AspNetCore.HttpLogging.HttpLoggingMiddleware": "Information"`
appsettings,LogLevel里面
