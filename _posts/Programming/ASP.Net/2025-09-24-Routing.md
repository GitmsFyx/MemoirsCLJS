---
categories: ASP.net
---

# 路由

```C#
//启用路由
app.UseRouting();

//定义端点
app.UseEndpoints(endpoints =>
{
    
});

app.Use(async (context,  next) =>
{
    ////获得当次请求的端点详细信息,必须在UseRouting后面才能有值
    Endpoint? endpoint = context.GetEndpoint();
    if (endpoint != null)
    {
        await context.Response.WriteAsync($"Endpoint:{endpoint.DisplayName}\n");
    }
    await next(context);
});

//会匹配没有进入Use的Url,无论GET/POST还是其他方法
app.Run(async context =>
{
    await context.Response.WriteAsync("Hello World!");
});

```

必须启用了才能使用端点.

## 路由参数

路由参数中大小写不敏感

`/files/{filename}.{extension}` 可变部分为路由参数,花括号外的为字面文本

`employee/profile/{employeename}`

必须符合结构.

```C#

app.UseEndpoints(endpoints =>
{
    endpoints.Map("files/{filename}.{extension}", async context =>
    {
        //context.Request.RouteValues获得路由值
        string? FileName = context.Request.RouteValues["filename"].ToString();
        //大小写不敏感
        string? Extension = context.Request.RouteValues["Extension"].ToString();
        await context.Response.WriteAsync($"Filename:{FileName}.{Extension}");
    });

    //{EmployeeName=harsha}提供默认值
    endpoints.Map("employee/profile/{EmployeeName=harsha}", async context =>
    {
        string? EmployeeName = context.Request.RouteValues["EmployeeName"].ToString();
        await context.Response.WriteAsync($"EmployeeName:{EmployeeName}");
    });

    //可选参数,不支持直接写id=null
    endpoints.Map("products/details/{id?}", async context =>
    {
     
    });

    //参数约束为ints
    endpoints.Map("products/details/{id:int?}", async context =>
    {
     
    });
    
    //约束最小长度和最大长度,先写约束再写默认值(或者使用length(value))
    endpoints.Map("employee/profile/{EmployeeName:minlength(3):maxlength(7)=harsha}", async context =>
    {
     
    });

    //length(),min(),max(),range(),alpha 只接受字母
    //regex(expression) 正则表达式 
});
```

### 控制器属性路由

在控制器上面表明路由,它将成为所有方法的通用前缀

```C#
[Route("persons")]
public class PersonsController : Controller
{
    //实际urL "persons/index"
    [Route("index")]

    //实际url "/" 如果你以斜杠开头那么就是绝对路径
    [Route("/")]

    public ActionResult Index()
    {
        return View();
    }
}
```

### 路由令牌 (首选方案)

使用方括号,这样控制器和方法会自动识别名称.

```C#
//这里为"Persons",不带后缀
[Route("[controller]")]
public class PersonsController : Controller
{
    //这里为"index"
    //实际urL "persons/index"
    [Route("[action]")]
    public ActionResult Index()
    {
        return View();
    }
}
```

### 自定义约束

自定义约束是一个类,优点是可以重复使用

```C#
//自定义类
public class MonthsCustomConstraints : IRouteConstraint
{
    public bool Match(HttpContext? httpContext, IRouter? route, string routeKey, RouteValueDictionary values,RouteDirection routeDirection)
    {
        //values是所有键
        //routeKey就是下面例子中的month(被约束的)
        if(!values.ContainsKey(routeKey))
        {
            return false;
        }

        Regex regex = new Regex("^(apr|jul|oct|jan)$");

        string? monthValue = Convert.ToString(values[routeKey]);

        if (regex.IsMatch(monthValue))
        {
            return true;
        }
        
        return false;
    }
}

//program.cs

//注册这个路由约束
builder.Services.AddRouting(options =>
{
    options.ConstraintMap.Add("months", typeof(MonthsCustomConstraints));
});

app.UseEndpoints(endpoints =>
{
    endpoints.Map("sales-report/{year:int:min(1900)}/{month:months}", async context =>
    {
        int year=Convert.ToInt32(context.Request.RouteValues["year"]);
        string? month=Convert.ToString(context.Request.RouteValues["month"]);
        await context.Response.WriteAsync($"Sales report for {month}/{year}");
    });
});

```

### 路由优先级

以下无上下关系  

URL|-|URL
-|-|-
`a/b/c/d` | > | `a/b/c`
`a/b` | > | `a/{parameter}`
`a/{b}:int` |>| `a/{b}`
`a/{b}` |>| `a/**`

