---
categories: ASP.net
---

# Filter

过滤管道

![image](/Images/FilterPipeline.png)

## IActionFilter

控制器的方法过滤器

创建过滤器
```C#
public class PersonsListActionFilter :IActionFilter
{
    private readonly ILogger<PersonsListActionFilter> _logger;

    public PersonsListActionFilter(ILogger<PersonsListActionFilter>  logger)
    {
        _logger = logger;
    }
    
    //在执行Action前
    public void OnActionExecuting(ActionExecutingContext context)
    {
        _logger.LogInformation("PersonsListActionFilter.onActionExecuting method");
    }
    
    //在执行Action后
    public void OnActionExecuted(ActionExecutedContext context)
    {
        _logger.LogInformation("PersonsListActionFilter.OnActionExecuted method");
    }
}
```
添加过滤器
```C#
//添加过滤器
[TypeFilter(typeof(PersonsListActionFilter))]
public async Task<ActionResult> Index()
{

}
```

例子
```C#
public void OnActionExecuting(ActionExecutingContext context)
{
    _logger.LogInformation("PersonsListActionFilter.onActionExecuting method");

    //查看action参数中是否包含searchBy
    if (context.ActionArguments.ContainsKey("searchBy"))
    {
        //转化为string
        var searchBy = Convert.ToString(context.ActionArguments["searchBy"]);
        
        //如果不为空
        if (!String.IsNullOrEmpty(searchBy))
        {
            //创建一个有效列表
            var searchByOptions = new List<string>()
            {
                nameof(PersonResponse.PersonName),
                nameof(PersonResponse.Email),
                nameof(PersonResponse.DateOfBirth),
                nameof(PersonResponse.Gender),
                nameof(PersonResponse.CountryId),
                nameof(PersonResponse.Address),
            };

            //如果searchBy不是有效列表中的值，就将它重置为PersonName.
            if (searchByOptions.Any(temp => temp == searchBy)==false)
            {
                _logger.LogInformation("searchBy actual value {searchBy}",searchBy);
                context.ActionArguments["searchBy"] = nameof(PersonResponse.PersonName);
                _logger.LogInformation("searchBy actual value {searchBy}",searchBy);
            }
        }
    }
}
```


# 过去版本
面向切面编程

IAsyncExceptionFilter

`OnExceptionAsync()`

## IAsyncActionFilter

分为前代码和后端码

OnActionExecutionAsync()

```C#
Console.Write("执行前");

//执行中,实际的执行代码.如果不调用就是终止
ActionExecutedContext result =await next();

//后代码
if(result.Exception!=null) 
{//发生异常};
else
{Console.Write("执行后")};

```

注册Filter,按照顺序来的

```C#

builder.Services.Configure<MvcOptions>(opt=>{
    opt.Filter.Add<MyActionFilter>();
    })
```